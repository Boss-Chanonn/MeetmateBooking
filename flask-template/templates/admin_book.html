{% extends "base.html" %}

{% block title %}Admin Booking{% endblock %}

{% block content %}
<div class="booking-page">
    <h1>Book a Room for Client</h1>      <form method="POST" action="{{ url_for('admin_book') }}" class="booking-form">
        <div class="form-group">
            <label for="client_id">Select Client</label>
            <select id="client_id" name="client_id" required>
                <option value="" disabled selected>-- Select a client --</option>
                {% for client in clients %}
                    <option value="{{ client.id }}">{{ client.firstname }} {{ client.lastname }} ({{ client.email }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="room_id">Select Room</label>
            <select id="room_id" name="room_id" required>
                <option value="" disabled selected>-- Select a room --</option>
                {% for room in rooms %}
                    <option value="{{ room.id }}">{{ room.name }} ({{ room.location }}, Capacity: {{ room.capacity }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" required min="{{ now.strftime('%Y-%m-%d') }}">
        </div>
        
        <div class="form-row">
            <div class="form-group half">
                <label for="time_start">Start Time</label>
                <select id="time_start" name="time_start" required>
                    <option value="" disabled selected>-- Select start time --</option>
                    {% for hour in range(8, 22) %}
                        <option value="{{ '%02d' % hour }}:00">{{ '%02d' % hour }}:00</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group half">
                <label for="time_end">End Time</label>
                <select id="time_end" name="time_end" required>
                    <option value="" disabled selected>-- Select end time --</option>
                    {% for hour in range(9, 23) %}
                        <option value="{{ '%02d' % hour }}:00">{{ '%02d' % hour }}:00</option>
                    {% endfor %}
                </select>            </div>
        </div>
        
        <div class="form-group">
            <label for="booking_notes">Booking Notes (Optional)</label>
            <textarea id="booking_notes" name="booking_notes" rows="3" placeholder="Add any special requirements or notes about this booking"></textarea>
        </div>
        
        <div class="form-group">
            <label class="checkbox-container">
                <input type="checkbox" id="is_recurring" name="is_recurring" value="1">
                <span class="checkbox-label">Make this a recurring booking</span>
            </label>
        </div>
        
        <div id="recurring-options" class="form-group hidden">
            <label for="recurrence_type">Recurrence Pattern</label>
            <select id="recurrence_type" name="recurrence_type">
                <option value="weekly">Weekly</option>
                <option value="biweekly">Bi-weekly</option>
                <option value="monthly">Monthly</option>
            </select>
            
            <div class="form-row">
                <div class="form-group half">
                    <label for="recurrence_count">Number of occurrences</label>
                    <input type="number" id="recurrence_count" name="recurrence_count" min="2" max="12" value="4">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Book Room for Client</button>
            <a href="{{ url_for('admin') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    
    <div class="booking-info">
        <h3>Booking Information</h3>
        <ul>
            <li>Rooms are available Monday to Friday, 8:00 AM to 10:00 PM</li>
            <li>Bookings can only be made on the hour (e.g., 10:00, 11:00)</li>
            <li>Minimum booking duration is 1 hour</li>
            <li>Maximum booking duration is 8 hours</li>
            <li>When booking for a client, a confirmation email will be sent to them</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recurring booking toggle
        const isRecurringCheckbox = document.getElementById('is_recurring');
        const recurringOptions = document.getElementById('recurring-options');
        
        isRecurringCheckbox.addEventListener('change', function() {
            if (this.checked) {
                recurringOptions.classList.remove('hidden');
            } else {
                recurringOptions.classList.add('hidden');
            }
        });
        
        // Set min date to today
        const dateInput = document.getElementById('date');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        
        const formattedDate = `${yyyy}-${mm}-${dd}`;
        dateInput.min = formattedDate;
        
        // Validate end time is after start time
        const startTimeSelect = document.getElementById('time_start');
        const endTimeSelect = document.getElementById('time_end');
        
        // Function to update end time options based on start time
        function updateEndTimeOptions() {
            const startTime = startTimeSelect.value;
            if (!startTime) return;
            
            const startHour = parseInt(startTime.split(':')[0], 10);
            
            // Clear existing options except the first placeholder
            while (endTimeSelect.options.length > 1) {
                endTimeSelect.remove(1);
            }
            
            // Add options that are at least 1 hour later than start time
            // Maximum is start time + 8 hours (for 8-hour booking) or 22 (10 PM), whichever is smaller
            const maxEndHour = Math.min(startHour + 8, 22);
            
            for (let hour = startHour + 1; hour <= maxEndHour; hour++) {
                const option = document.createElement('option');
                option.value = `${String(hour).padStart(2, '0')}:00`;
                option.text = `${String(hour).padStart(2, '0')}:00`;
                endTimeSelect.add(option);
            }
            
            // Enable the end time select
            endTimeSelect.disabled = false;
        }
        
        // Function to validate booking duration
        function validateBookingDuration() {
            const startTime = startTimeSelect.value;
            const endTime = endTimeSelect.value;
            
            if (startTime && endTime) {
                const startHour = parseInt(startTime.split(':')[0], 10);
                const endHour = parseInt(endTime.split(':')[0], 10);
                
                if (endHour - startHour < 1 || endHour - startHour > 8) {
                    alert('Booking duration must be between 1 and 8 hours.');
                    endTimeSelect.value = '';
                }
            }
        }
        
        // Add event listeners
        startTimeSelect.addEventListener('change', updateEndTimeOptions);
        endTimeSelect.addEventListener('change', validateBookingDuration);
    });
</script>

<style>
    .hidden {
        display: none;
    }
    
    .checkbox-container {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin: 0.5rem 0;
    }
    
    .checkbox-container input {
        margin-right: 0.5rem;
    }
    
    .checkbox-label {
        font-weight: normal;
    }
    
    textarea {
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.5rem;
        font-family: inherit;
        font-size: 0.9rem;
    }
</style>
{% endblock %}
